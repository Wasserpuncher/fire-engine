<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; blob:;">
    <meta name="description" content="FIRE-Engine: A 100% local, privacy-first Financial Independence and Retire Early (FIRE) Monte Carlo Simulator.">
    <title>FIRE-Engine | Financial Independence Simulator</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. CSS VARIABLES & DESIGN SYSTEM --- */
        :root {
            /* Dark Mode Core (Modern Finance Aesthetic) */
            --bg-base: #0f172a;       /* Slate 900 */
            --bg-panel: #1e293b;      /* Slate 800 */
            --bg-card: #334155;       /* Slate 700 */
            --text-main: #f8fafc;     /* Slate 50 */
            --text-muted: #94a3b8;    /* Slate 400 */
            
            /* Accents & Brand */
            --primary: #10b981;       /* Emerald 500 (Money/Growth) */
            --primary-hover: #059669; /* Emerald 600 */
            --primary-glow: rgba(16, 185, 129, 0.2);
            --secondary: #3b82f6;     /* Blue 500 (Information) */
            --accent: #8b5cf6;        /* Violet 500 (Advanced/Magic) */
            
            /* Status Colors */
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #475569;        /* Slate 600 */
            
            /* Typography */
            --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            /* Layout */
            --sidebar-width: 420px;
            --header-height: 70px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        /* --- 2. RESET & GLOBAL STYLES --- */
        *, *::before, *::after { box-sizing: border-box; }
        
        body {
            margin: 0; padding: 0; font-family: var(--font-sans);
            background-color: var(--bg-base); color: var(--text-main);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-base); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Typography Utility */
        h1, h2, h3, h4 { margin: 0; font-weight: 700; color: var(--text-main); }
        p { margin: 0 0 1rem 0; line-height: 1.6; }
        .text-primary { color: var(--primary); }
        .text-muted { color: var(--text-muted); }
        .mono { font-family: var(--font-mono); }

        /* --- 3. LAYOUT STRUCTURE --- */
        header {
            height: var(--header-height); background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border); display: flex;
            justify-content: space-between; align-items: center; padding: 0 30px;
            z-index: 10; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-brand h1 { font-size: 1.5rem; letter-spacing: -0.5px; }
        .badge-local { 
            background: rgba(16, 185, 129, 0.1); color: var(--primary); 
            border: 1px solid var(--primary); padding: 4px 10px; 
            border-radius: 20px; font-size: 0.75rem; font-weight: bold; 
            display: flex; align-items: center; gap: 6px;
        }
        .badge-local::before {
            content: ''; display: inline-block; width: 8px; height: 8px;
            background: var(--primary); border-radius: 50%;
            box-shadow: 0 0 8px var(--primary);
        }

        .workspace { display: flex; flex: 1; overflow: hidden; height: calc(100vh - var(--header-height)); }

        /* --- 4. SIDEBAR (INPUT CONTROLS) --- */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--bg-panel);
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            overflow-y: auto; z-index: 5;
        }

        .control-section { padding: 25px; border-bottom: 1px solid var(--border); }
        .control-section h2 { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;}
        
        .input-group { margin-bottom: 16px; position: relative; }
        .input-group label { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }
        .input-hint { font-size: 0.75rem; color: var(--text-muted); font-weight: normal; }
        
        .input-wrapper { display: flex; align-items: center; background: var(--bg-base); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; transition: border-color 0.2s; }
        .input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
        .input-prefix, .input-suffix { padding: 10px 15px; color: var(--text-muted); font-weight: 600; background: rgba(0,0,0,0.2); font-family: var(--font-mono); }
        
        input[type="number"], input[type="text"] {
            flex: 1; background: transparent; border: none; color: var(--text-main);
            padding: 10px; font-size: 1rem; font-family: var(--font-mono); font-weight: bold;
            width: 100%; outline: none; text-align: right;
        }

        /* Range Slider Styling */
        input[type="range"] {
            width: 100%; appearance: none; background: transparent; margin-top: 10px;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; background: var(--bg-card); border-radius: 3px; border: 1px solid var(--border);
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: var(--primary); cursor: pointer; margin-top: -7px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* --- 5. MAIN DASHBOARD --- */
        .dashboard {
            flex: 1; overflow-y: auto; background-color: var(--bg-base);
            padding: 30px; display: flex; flex-direction: column; gap: 25px;
        }

        /* KPI Cards Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .kpi-card {
            background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; overflow: hidden;
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--primary);
        }
        .kpi-card.blue::before { background: var(--secondary); }
        .kpi-card.purple::before { background: var(--accent); }
        .kpi-card.warning::before { background: var(--warning); }
        
        .kpi-title { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; font-weight: bold; margin-bottom: 8px; }
        .kpi-value { font-size: 2rem; font-weight: 800; font-family: var(--font-mono); color: var(--text-main); }
        .kpi-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }

        /* Chart Container */
        .chart-container {
            background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: var(--radius-xl); padding: 25px; height: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative;
        }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Data Table */
        .table-container {
            background: var(--bg-panel); border: 1px solid var(--border);
            border-radius: var(--radius-lg); overflow: hidden;
        }
        .table-header-row { background: var(--bg-card); border-bottom: 2px solid var(--border); }
        table { width: 100%; border-collapse: collapse; text-align: right; font-family: var(--font-mono); font-size: 0.9rem; }
        th { padding: 15px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 0.75rem; font-family: var(--font-sans);}
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover td { background: rgba(255,255,255,0.02); }
        .col-year { text-align: left; font-weight: bold; color: var(--text-main); }
        .col-pos { color: var(--success); }
        .col-neg { color: var(--danger); }

        /* Buttons & Actions */
        .btn {
            background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: var(--radius-md); font-weight: 600;
            cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
            font-family: var(--font-sans); font-size: 0.9rem;
        }
        .btn:hover { background: var(--border); }
        .btn-primary { background: var(--primary); color: #000; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); color: #fff; box-shadow: 0 4px 12px var(--primary-glow); }
        .btn-accent { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn-accent:hover { background: #7c3aed; }

        /* Loading Overlay for Monte Carlo */
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border-radius: var(--radius-xl); z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #loading-overlay.active { opacity: 1; pointer-events: all; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--border);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Status Indicators */
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .bg-success { background-color: var(--success); box-shadow: 0 0 8px var(--success);}
        .bg-warning { background-color: var(--warning); box-shadow: 0 0 8px var(--warning);}
        .bg-danger { background-color: var(--danger); box-shadow: 0 0 8px var(--danger);}

    </style>
</head>
<body>

    <header>
        <div class="header-brand">
            <h1>üìä FIRE-Engine</h1>
            <div class="badge-local">100% LOCAL EXECUTION</div>
        </div>
        <div class="header-actions">
            <button class="btn" onclick="resetDefaults()">üîÑ Reset Defaults</button>
            <button class="btn btn-primary" onclick="exportData()">‚¨áÔ∏è Export CSV</button>
        </div>
    </header>

    <div class="workspace">
        
        <aside class="sidebar" id="sidebar">
            
            <div class="control-section">
                <h2>‚è≥ Timeline</h2>
                
                <div class="input-group">
                    <label>Current Age <span id="val-age" class="text-primary">30</span></label>
                    <input type="range" id="inp-age" min="18" max="70" value="30" step="1">
                </div>
                
                <div class="input-group">
                    <label>Target Retirement Age <span id="val-ret-age" class="text-primary">50</span></label>
                    <input type="range" id="inp-ret-age" min="30" max="80" value="50" step="1">
                    <div class="input-hint" style="margin-top: 5px;">Years to compound: <strong id="val-years-accumulate" class="text-main">20</strong></div>
                </div>
                
                <div class="input-group" style="margin-bottom: 0;">
                    <label>Life Expectancy (End of Plan) <span id="val-death-age" class="text-primary">90</span></label>
                    <input type="range" id="inp-death-age" min="70" max="110" value="90" step="1">
                    <div class="input-hint" style="margin-top: 5px;">Years in retirement: <strong id="val-years-retire" class="text-main">40</strong></div>
                </div>
            </div>

            <div class="control-section">
                <h2>üí∞ Current Financials</h2>
                
                <div class="input-group">
                    <label>Current Portfolio Value (Invested) <span class="input-hint">Net Worth</span></label>
                    <div class="input-wrapper">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" id="inp-nw" value="50000" step="1000">
                    </div>
                </div>

                <div class="input-group">
                    <label>Monthly Net Income <span class="input-hint">After Taxes</span></label>
                    <div class="input-wrapper">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" id="inp-income" value="3500" step="100">
                    </div>
                </div>

                <div class="input-group">
                    <label>Monthly Expenses (Current) <span class="input-hint">Cost of Living</span></label>
                    <div class="input-wrapper">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" id="inp-expenses" value="2000" step="100">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px dashed var(--border);">
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px;">
                        <span>Monthly Savings:</span>
                        <strong class="text-primary mono" id="calc-savings">‚Ç¨1,500</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                        <span>Savings Rate:</span>
                        <strong class="text-secondary mono" id="calc-savings-rate">42.8%</strong>
                    </div>
                </div>
            </div>

            <div class="control-section">
                <h2>üéØ FIRE Target (Trinity Study)</h2>
                
                <div class="input-group">
                    <label>Expected Monthly Expenses in Retirement</label>
                    <div class="input-wrapper">
                        <span class="input-prefix">‚Ç¨</span>
                        <input type="number" id="inp-ret-expenses" value="2500" step="100">
                    </div>
                    <div class="input-hint" style="margin-top: 5px;">Will be automatically adjusted for inflation.</div>
                </div>

                <div class="input-group" style="margin-bottom: 0;">
                    <label title="Safe Withdrawal Rate based on the Trinity Study (usually 3.5% - 4.0%)">Safe Withdrawal Rate (SWR) <span id="val-swr" class="text-primary">4.0%</span></label>
                    <input type="range" id="inp-swr" min="2.0" max="6.0" value="4.0" step="0.1">
                    <div class="input-hint" style="margin-top: 5px;">Calculated FIRE Number: <strong class="text-main mono" id="calc-fire-number">‚Ç¨750,000</strong></div>
                </div>
            </div>

            <div class="control-section">
                <h2>üìà Market Assumptions</h2>
                <p class="input-hint" style="margin-bottom: 15px;">Used for the 10,000 Monte-Carlo Simulation paths.</p>
                
                <div style="display: flex; gap: 15px;">
                    <div class="input-group" style="flex: 1;">
                        <label>Avg. Return</label>
                        <div class="input-wrapper">
                            <input type="number" id="inp-return" value="7.0" step="0.1">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label title="Standard Deviation (Volatility of the market). Historically ~15% for S&P500.">Volatility (œÉ)</label>
                        <div class="input-wrapper">
                            <input type="number" id="inp-volatility" value="15.0" step="0.1">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div class="input-group" style="flex: 1;">
                        <label>Inflation</label>
                        <div class="input-wrapper">
                            <input type="number" id="inp-inflation" value="2.5" step="0.1">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <div class="input-group" style="flex: 1;">
                        <label title="Tax drag on returns (Capital gains tax estimate)">Tax Drag</label>
                        <div class="input-wrapper">
                            <input type="number" id="inp-tax" value="26.375" step="0.001">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-accent" style="width: 100%; justify-content: center; margin-top: 10px;" onclick="runSimulation()">
                    üé≤ Run 10,000 Simulations
                </button>
            </div>
            
            <div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem;">
                Powered by Web Workers.<br>No data leaves your browser.
            </div>

        </aside>

        <main class="dashboard" id="dashboard">
            
            <div class="kpi-grid">
                <div class="kpi-card blue">
                    <div class="kpi-title">FIRE Target Amount (Today's ‚Ç¨)</div>
                    <div class="kpi-value" id="kpi-target">‚Ç¨0</div>
                    <div class="kpi-subtitle">Needed to sustain ‚Ç¨<span id="kpi-monthly-ret">0</span>/mo at <span id="kpi-swr">0</span>% SWR</div>
                </div>
                
                <div class="kpi-card">
                    <div class="kpi-title">Projected Portfolio at Retirement</div>
                    <div class="kpi-value" id="kpi-projected">‚Ç¨0</div>
                    <div class="kpi-subtitle">Median outcome (50th Percentile)</div>
                </div>
                
                <div class="kpi-card warning">
                    <div class="kpi-title">Inflation Adjusted FIRE Number</div>
                    <div class="kpi-value" id="kpi-target-inflated">‚Ç¨0</div>
                    <div class="kpi-subtitle">Actual purchasing power needed in Year <span id="kpi-ret-year">0</span></div>
                </div>
                
                <div class="kpi-card purple">
                    <div class="kpi-title">Monte Carlo Success Rate</div>
                    <div class="kpi-value" id="kpi-success">0.0%</div>
                    <div class="kpi-subtitle" id="kpi-success-desc">Paths that didn't run out of money</div>
                </div>
            </div>

            <div class="chart-container">
                <div id="loading-overlay">
                    <div class="spinner"></div>
                    <div style="font-family: var(--font-mono); font-weight: bold; color: var(--primary);">Simulating 10,000 Lifetimes...</div>
                </div>
                <div class="chart-header">
                    <h2>Monte Carlo Net Worth Projection</h2>
                    <div style="display: flex; gap: 15px; font-size: 0.85rem; font-family: var(--font-mono);">
                        <span style="color: var(--success);">Top 10% (Lucky)</span>
                        <span style="color: var(--secondary);">Median (Expected)</span>
                        <span style="color: var(--danger);">Bottom 10% (Unlucky)</span>
                    </div>
                </div>
                <div style="height: calc(100% - 60px); width: 100%;">
                    <canvas id="fireChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.2rem;">Median Path Breakdown</h2>
                    <span class="badge-local">Inflation Adjusted (Real ‚Ç¨)</span>
                </div>
                <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                    <table id="data-table">
                        <thead style="position: sticky; top: 0; z-index: 2;">
                            <tr class="table-header-row">
                                <th style="text-align: left;">Age / Year</th>
                                <th>Phase</th>
                                <th>Starting NW</th>
                                <th>Contributions / Withdrawals</th>
                                <th>Investment Return</th>
                                <th>Ending NW</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- 1. STATE & DOM ELEMENTS ---
        const state = {
            age: 30, retAge: 50, deathAge: 90,
            nw: 50000, income: 3500, expenses: 2000,
            retExpenses: 2500, swr: 4.0,
            returnRate: 7.0, volatility: 15.0, inflation: 2.5, taxDrag: 26.375
        };

        const STORAGE_KEY = 'fire_engine_state_v1';
        let fireChart = null;

        // --- 2. THE WEB WORKER CODE (MONTE CARLO SIMULATION) ---
        // We embed the worker script as a string to keep this a single-file application.
        // It uses the Box-Muller transform to generate normally distributed random market returns.
        const workerScript = `
            // Helper: Standard Normal Distribution (Box-Muller Transform)
            function randomNormal() {
                let u = 0, v = 0;
                while(u === 0) u = Math.random();
                while(v === 0) v = Math.random();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            self.onmessage = function(e) {
                const p = e.data; // Parameters
                const numSimulations = 10000;
                const yearsToSimulate = p.deathAge - p.age;
                const yearsToRetire = p.retAge - p.age;
                
                const realReturnMean = (p.returnRate - p.inflation) / 100;
                const realVol = p.volatility / 100;
                
                let paths = [];
                let successCount = 0;

                for (let i = 0; i < numSimulations; i++) {
                    let nw = p.nw;
                    let path = [nw];
                    let failed = false;

                    for (let year = 1; year <= yearsToSimulate; year++) {
                        // Random market return for this year
                        let marketReturn = realReturnMean + (randomNormal() * realVol);
                        
                        // Apply Tax Drag (simplified: reduces positive returns)
                        if (marketReturn > 0) {
                            marketReturn = marketReturn * (1 - (p.taxDrag / 100));
                        }

                        // Grow portfolio
                        nw = nw * (1 + marketReturn);

                        // Cashflow
                        if (year <= yearsToRetire) {
                            // Accumulation Phase: Add annual savings
                            // Note: Doing it annually for speed, though monthly is more accurate
                            nw += p.annualSavings; 
                        } else {
                            // Retirement Phase: Subtract annual expenses
                            // Since we use real returns (adjusted for inflation), we subtract the today-value
                            nw -= p.annualRetExpenses;
                        }

                        if (nw < 0) {
                            nw = 0;
                            failed = true;
                        }
                        path.push(nw);
                    }
                    
                    if (!failed) successCount++;
                    paths.push(path);
                }

                // Calculate Percentiles per year
                let percentiles = { 10: [], 50: [], 90: [] };
                
                for (let year = 0; year <= yearsToSimulate; year++) {
                    // Extract all net worths for this specific year across all 10k simulations
                    let yearValues = paths.map(p => p[year]);
                    yearValues.sort((a, b) => a - b);
                    
                    percentiles['10'].push(yearValues[Math.floor(numSimulations * 0.10)]);
                    percentiles['50'].push(yearValues[Math.floor(numSimulations * 0.50)]);
                    percentiles['90'].push(yearValues[Math.floor(numSimulations * 0.90)]);
                }

                self.postMessage({
                    percentiles: percentiles,
                    successRate: (successCount / numSimulations) * 100
                });
            };
        `;

        // Create the worker blob
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob));

        // --- 3. UI SYNC & LOCAL STORAGE ---
        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) Object.assign(state, JSON.parse(saved));
            } catch (e) { console.error("Could not load state", e); }
            updateInputsFromState();
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function resetDefaults() {
            if(confirm("Reset all values to default?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function syncInput(id, stateKey, isFloat = false) {
            const el = document.getElementById(id);
            el.addEventListener('input', (e) => {
                let val = isFloat ? parseFloat(e.target.value) : parseInt(e.target.value, 10);
                if(isNaN(val)) val = 0;
                state[stateKey] = val;
                
                // Update related display values if it's a slider
                if(id.startsWith('inp-age')) document.getElementById('val-age').innerText = val;
                if(id.startsWith('inp-ret-age')) document.getElementById('val-ret-age').innerText = val;
                if(id.startsWith('inp-death-age')) document.getElementById('val-death-age').innerText = val;
                if(id.startsWith('inp-swr')) document.getElementById('val-swr').innerText = val.toFixed(1) + '%';
                
                updateCalculatedFields();
                debounceSimulation();
            });
        }

        function updateInputsFromState() {
            document.getElementById('inp-age').value = state.age;
            document.getElementById('val-age').innerText = state.age;
            document.getElementById('inp-ret-age').value = state.retAge;
            document.getElementById('val-ret-age').innerText = state.retAge;
            document.getElementById('inp-death-age').value = state.deathAge;
            document.getElementById('val-death-age').innerText = state.deathAge;
            
            document.getElementById('inp-nw').value = state.nw;
            document.getElementById('inp-income').value = state.income;
            document.getElementById('inp-expenses').value = state.expenses;
            document.getElementById('inp-ret-expenses').value = state.retExpenses;
            
            document.getElementById('inp-swr').value = state.swr;
            document.getElementById('val-swr').innerText = state.swr.toFixed(1) + '%';
            
            document.getElementById('inp-return').value = state.returnRate;
            document.getElementById('inp-volatility').value = state.volatility;
            document.getElementById('inp-inflation').value = state.inflation;
            document.getElementById('inp-tax').value = state.taxDrag;
            
            updateCalculatedFields();
        }

        function updateCalculatedFields() {
            // Validate timeline
            if(state.retAge <= state.age) { state.retAge = state.age + 1; document.getElementById('inp-ret-age').value = state.retAge; document.getElementById('val-ret-age').innerText = state.retAge; }
            if(state.deathAge <= state.retAge) { state.deathAge = state.retAge + 1; document.getElementById('inp-death-age').value = state.deathAge; document.getElementById('val-death-age').innerText = state.deathAge; }

            const yearsAcc = state.retAge - state.age;
            const yearsRet = state.deathAge - state.retAge;
            document.getElementById('val-years-accumulate').innerText = yearsAcc;
            document.getElementById('val-years-retire').innerText = yearsRet;

            const savings = state.income - state.expenses;
            const savingsRate = state.income > 0 ? (savings / state.income) * 100 : 0;
            
            document.getElementById('calc-savings').innerText = formatCurrency(savings);
            document.getElementById('calc-savings').className = savings > 0 ? 'text-primary mono' : 'text-danger mono';
            document.getElementById('calc-savings-rate').innerText = savingsRate.toFixed(1) + '%';

            // FIRE Number Calculation (Trinity Math: Annual Expenses / SWR)
            const annualRetExp = state.retExpenses * 12;
            const fireNumber = annualRetExp / (state.swr / 100);
            document.getElementById('calc-fire-number').innerText = formatCurrency(fireNumber);
            
            // Update KPIs
            document.getElementById('kpi-target').innerText = formatCurrency(fireNumber);
            document.getElementById('kpi-monthly-ret').innerText = state.retExpenses.toLocaleString();
            document.getElementById('kpi-swr').innerText = state.swr.toFixed(1);
            
            // Inflated FIRE Number (What it actually costs in X years due to inflation)
            const inflatedFireNumber = fireNumber * Math.pow(1 + (state.inflation / 100), yearsAcc);
            document.getElementById('kpi-target-inflated').innerText = formatCurrency(inflatedFireNumber);
            document.getElementById('kpi-ret-year').innerText = new Date().getFullYear() + yearsAcc;
            
            saveState();
        }

        // --- 4. DEBOUNCE & SIMULATION RUNNER ---
        let simTimeout;
        function debounceSimulation() {
            clearTimeout(simTimeout);
            simTimeout = setTimeout(runSimulation, 500); // Wait 500ms after user stops typing
        }

        function runSimulation() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('active');

            const annualSavings = (state.income - state.expenses) * 12;
            const annualRetExpenses = state.retExpenses * 12;

            // Send payload to Web Worker
            worker.postMessage({
                age: state.age,
                retAge: state.retAge,
                deathAge: state.deathAge,
                nw: state.nw,
                annualSavings: annualSavings,
                annualRetExpenses: annualRetExpenses,
                returnRate: state.returnRate,
                volatility: state.volatility,
                inflation: state.inflation,
                taxDrag: state.taxDrag
            });
        }

        // Listen for Worker completion
        let lastSimulationData = null; // Store for export
        worker.onmessage = function(e) {
            const data = e.data;
            lastSimulationData = data;
            
            // Update UI
            document.getElementById('loading-overlay').classList.remove('active');
            
            const sr = data.successRate;
            const kpiSuccess = document.getElementById('kpi-success');
            kpiSuccess.innerText = sr.toFixed(1) + '%';
            
            if(sr >= 95) kpiSuccess.style.color = 'var(--success)';
            else if(sr >= 80) kpiSuccess.style.color = 'var(--warning)';
            else kpiSuccess.style.color = 'var(--danger)';

            // Update Projected NW at Retirement (Median)
            const yearsAcc = state.retAge - state.age;
            const projectedAtRet = data.percentiles['50'][yearsAcc];
            document.getElementById('kpi-projected').innerText = formatCurrency(projectedAtRet);

            renderChart(data.percentiles);
            renderTable(data.percentiles['50']); // Render table using median path
        };

        // --- 5. CHART.JS INTEGRATION ---
        function renderChart(percentiles) {
            const ctx = document.getElementById('fireChart').getContext('2d');
            
            const labels = [];
            const currentYear = new Date().getFullYear();
            const totalYears = state.deathAge - state.age;
            for(let i=0; i<=totalYears; i++) {
                labels.push(`${currentYear + i} (Age ${state.age + i})`);
            }

            // Create annotation line for Retirement Year
            const retIndex = state.retAge - state.age;

            const dataSets = [
                {
                    label: 'Top 10% (Lucky Market)',
                    data: percentiles['90'],
                    borderColor: 'rgba(34, 197, 94, 0.4)', // Success Green
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    tension: 0.4
                },
                {
                    label: 'Median (Expected)',
                    data: percentiles['50'],
                    borderColor: 'rgba(59, 130, 246, 1)', // Blue
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Bottom 10% (Unlucky Market)',
                    data: percentiles['10'],
                    borderColor: 'rgba(239, 68, 68, 0.8)', // Danger Red
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.4
                }
            ];

            if (fireChart) {
                fireChart.data.labels = labels;
                fireChart.data.datasets = dataSets;
                
                // Update Retirement Line Annotation dynamically via options
                fireChart.options.plugins.annotation = getAnnotations(retIndex);
                fireChart.update();
            } else {
                Chart.defaults.color = '#94a3b8';
                Chart.defaults.font.family = "'JetBrains Mono', monospace";
                
                fireChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: dataSets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: {
                                    callback: function(value) {
                                        if(value >= 1000000) return '‚Ç¨' + (value/1000000).toFixed(1) + 'M';
                                        if(value >= 1000) return '‚Ç¨' + (value/1000).toFixed(0) + 'k';
                                        return '‚Ç¨' + value;
                                    }
                                }
                            },
                            x: { grid: { display: false } }
                        },
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleFont: { size: 14 },
                                bodyFont: { size: 13 },
                                padding: 15,
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Custom plugin logic to draw vertical line at retirement (Simplified for standard Chart.js without plugins)
        const originalDraw = Chart.controllers.line.prototype.draw;
        Chart.controllers.line.prototype.draw = function() {
            originalDraw.apply(this, arguments);
            const chart = this.chart;
            const ctx = chart.ctx;
            const retIndex = state.retAge - state.age;
            
            if(retIndex >= 0 && retIndex < chart.scales.x.ticks.length) {
                const xaxis = chart.scales.x;
                const yaxis = chart.scales.y;
                const x = xaxis.getPixelForTick(retIndex);
                
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, yaxis.top);
                ctx.lineTo(x, yaxis.bottom);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'rgba(245, 158, 11, 0.5)'; // Warning Yellow
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                
                // Draw Label
                ctx.fillStyle = 'rgba(245, 158, 11, 0.8)';
                ctx.font = "bold 12px 'Inter'";
                ctx.fillText("FIRE DATE", x + 5, yaxis.top + 15);
                ctx.restore();
            }
        };


        // --- 6. DATA TABLE GENERATION ---
        function renderTable(medianPath) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            const totalYears = state.deathAge - state.age;
            const annualSavings = (state.income - state.expenses) * 12;
            const annualRetExpenses = state.retExpenses * 12;

            for(let i=1; i<=totalYears; i++) {
                const yearAge = state.age + i;
                const yearDate = currentYear + i;
                const isRetirement = yearAge > state.retAge;
                
                const startNw = medianPath[i-1];
                const endNw = medianPath[i];
                
                let cashflow = isRetirement ? -annualRetExpenses : annualSavings;
                
                // Back-calculate the investment return generated in that year
                // endNw = (startNw * (1+return)) + cashflow
                const investmentReturn = endNw - startNw - cashflow;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-year">Age ${yearAge} <br><small class="text-muted">${yearDate}</small></td>
                    <td><span class="badge-local" style="display:inline-block; border-color: ${isRetirement ? 'var(--warning)' : 'var(--success)'}; color: ${isRetirement ? 'var(--warning)' : 'var(--success)'}">${isRetirement ? 'RETIRED' : 'ACCUMULATION'}</span></td>
                    <td>${formatCurrency(startNw)}</td>
                    <td class="${cashflow > 0 ? 'col-pos' : 'col-neg'}">${cashflow > 0 ? '+' : ''}${formatCurrency(cashflow)}</td>
                    <td class="${investmentReturn >= 0 ? 'col-pos' : 'col-neg'}">${investmentReturn >= 0 ? '+' : ''}${formatCurrency(investmentReturn)}</td>
                    <td style="font-weight: bold; color: var(--text-main);">${formatCurrency(endNw)}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        // --- 7. UTILITIES & EXPORT ---
        function formatCurrency(num) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(num);
        }

        function exportData() {
            if(!lastSimulationData) { alert("Please run the simulation first."); return; }
            
            let csv = "Age,Year,Phase,Median_NetWorth,Top10_NetWorth,Bottom10_NetWorth\n";
            const currentYear = new Date().getFullYear();
            const totalYears = state.deathAge - state.age;
            
            for(let i=0; i<=totalYears; i++) {
                const age = state.age + i;
                const year = currentYear + i;
                const phase = age > state.retAge ? 'Retired' : 'Working';
                const p50 = lastSimulationData.percentiles['50'][i].toFixed(2);
                const p90 = lastSimulationData.percentiles['90'][i].toFixed(2);
                const p10 = lastSimulationData.percentiles['10'][i].toFixed(2);
                
                csv += `${age},${year},${phase},${p50},${p90},${p10}\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FIRE_Engine_Export_${currentYear}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- 8. INIT BINDINGS ---
        window.onload = () => {
            // Bind all inputs
            syncInput('inp-age', 'age');
            syncInput('inp-ret-age', 'retAge');
            syncInput('inp-death-age', 'deathAge');
            syncInput('inp-nw', 'nw');
            syncInput('inp-income', 'income');
            syncInput('inp-expenses', 'expenses');
            syncInput('inp-ret-expenses', 'retExpenses');
            syncInput('inp-swr', 'swr', true);
            syncInput('inp-return', 'returnRate', true);
            syncInput('inp-volatility', 'volatility', true);
            syncInput('inp-inflation', 'inflation', true);
            syncInput('inp-tax', 'taxDrag', true);

            loadState(); // Also triggers simulation
        };

    </script>
</body>
</html>
